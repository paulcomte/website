<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>ðŸ“¡ A protocol system in C++</title><meta content="ðŸ“¡ A protocol system in C++" name=title><meta content="Paul Comte" name=author><meta content="Creating a protocol system in C++ might seem not trivial at first, but actually is fairly pretty simple" name=description><meta content=website property=og:type><meta content=https://paulcomte.cafe/blog/a-protocol-system/ property=og:url><meta content="Paul Comte" property=og:site_name><meta content="ðŸ“¡ A protocol system in C++" property=og:title><meta content="Creating a protocol system in C++ might seem not trivial at first, but actually is fairly pretty simple" property=og:description><meta content=https://paulcomte.cafe/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://paulcomte.cafe/blog/a-protocol-system/ property=twitter:url><meta content="ðŸ“¡ A protocol system in C++" property=twitter:title><meta content="Creating a protocol system in C++ might seem not trivial at first, but actually is fairly pretty simple" property=twitter:description><meta content=https://paulcomte.cafe/favicon.ico property=twitter:image><link href=https://paulcomte.cafe/blog/a-protocol-system/ rel=canonical><link rel="shortcut icon" href=https://paulcomte.cafe/favicon.ico type=image/x-icon><link href=https://paulcomte.cafe/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://paulcomte.cafe/css/style.css rel=stylesheet><script data-default-theme=dark defer id=config src=https://paulcomte.cafe/js/script.js></script><body><div class=wrapper><header><div class=header><div class=rss><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=icons__background href=https://paulcomte.cafe/atom.xml target=_blank><svg class="icons icons__background"><use href=https://paulcomte.cafe/icons.svg#rss></use></svg></a></div><nav class=navBar><a href=/> /home/ </a><a href=/projects> /projects/ </a><a href=/blog> /blog/ </a><a href=https://github.com/paulcomte> /github/ </a><a href=https://www.linkedin.com/in/im-paul-comte> /linkedin/ </a><div class=themeSwitch><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode"><svg class="icons icons__background"><use href=https://paulcomte.cafe/icons.svg#darkMode></use></svg></button><button class="themeButton light" onclick="setTheme('light')" title="Light mode"><svg class="icons icons__background"><use href=https://paulcomte.cafe/icons.svg#lightMode></use></svg></button></div></nav></div></header><main><div><a href=..>..</a>/<span class=metaData>a-protocol-system</span></div><time datetime=2023-03-24>Published on: <span class=metaData>2023-03-24</span></time><address rel=author>By <span class=metaData>Paul Comte</span></address><h1>ðŸ“¡ A protocol system in C++</h1><h2>Table of contents</h2><ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#repository>Repository</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#introduction>Introduction</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#tech-stack>Tech stack</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#architecture>Architecture</a> <ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#packetmanager>PacketManager</a> <ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#global-functions>Global functions</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#handlepacket-packet-packet>handlePacket(Packet &packet)</a></ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#packethandler>PacketHandler</a> <ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#serverpackethandler>ServerPacketHandler</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#clientpackethandler>ClientPacketHandler</a></ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#fields>Fields</a> <ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#character-field>Character field</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#integer-field-4-bytes>Integer field (4 bytes)</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#unsigned-integer-field-4-bytes>Unsigned Integer field (4 bytes)</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#unsigned-integer-64-field-8-bytes>Unsigned Integer 64 field (8 bytes)</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#string-field>String field</a></ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#packets>Packets</a> <ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#calluppacket>CallUpPacket</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#hanguppacket>HangUpPacket</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#contactpacket>ContactPacket</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#loginerrorpacket>LoginErrorPacket</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#loginpacket>LoginPacket</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#logoutpacket>LogoutPacket</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#messagepacket>MessagePacket</a></ul></ul><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#sample-implementation>Sample implementation</a><li><a href=https://paulcomte.cafe/blog/a-protocol-system/#future>Future ?</a></ul><h2 id=repository><a href=https://github.com/paulcomte/babel/tree/main/protocol rel=noopener target=_blank>Repository</a></h2><h2 id=introduction>Introduction</h2><p>During the realization of the <code>Babel</code> project, I had to work on a protocol system, to enable interactions between the client and the server.<p>If you want more details about the base project, feel free to click <a href=/projects/babel>here</a>.<h2 id=tech-stack>Tech stack</h2><ul><li>Programming language: C++</ul><blockquote><p>The protocol system does not depend on anything else.</blockquote><h2 id=architecture>Architecture</h2><blockquote><h3 id=packetmanager>PacketManager</h3></blockquote><ul><li><h4 id=global-functions>Global functions</h4> <ul><li><h5 id=deserialize-std-string-packet>deserialize(std::string &packet)</h5> <pre><code>1. message[0] == '0x32'?
   We check if the first byte is our magic value.

2. PacketType = message[1]
   We retrieve the packet type from the next byte.

3. PacketField[] = message[2..]
   We convert the rest of the content into a list of packet field.

4. Packet = Deserialize(PacketType, PacketField[])
   We call the deserialize function for the specific packet type, with the list of packet fields.
</code></pre><li><h5 id=serialize-packet>serialize(Packet&)</h5> <blockquote><p>It will simply call the <code>serialize</code> inherited function from the Packet class.</blockquote></ul><li><h4 id=handlepacket-packet-packet>handlePacket(Packet &packet)</h4> <ul><li><h5 id=server-side-implementation><a href=https://github.com/paulcomte/babel/blob/main/protocol/server/ServerPacketManager.cpp rel=noopener target=_blank>Server-side implementation</a></h5><li><h5 id=client-side-implementation><a href=https://github.com/paulcomte/babel/blob/main/protocol/client/ClientPacketManager.cpp rel=noopener target=_blank>Client-side implementation</a></h5></ul> <p>A trivial implementation of the <code>handlePacket</code> function is to simply loop through all <code>PacketHandler</code>s, to target the one registered for the received packet.</p> <p>You can also use a <code>HashMap&LTPacketType, PacketHandler></code>.</p></ul><blockquote><h3 id=packethandler>PacketHandler</h3></blockquote><ul><li><h4 id=serverpackethandler>ServerPacketHandler</h4> <pre><code>handle(Packet&, std::shared_ptr&LTServerManager>, IoClient*)
</code></pre><li><h4 id=clientpackethandler>ClientPacketHandler</h4> <pre><code>handle(Packet&, std::shared_ptr&LTClientManager>)
</code></pre></ul><blockquote><h3 id=fields>Fields</h3></blockquote><p><u><strong>Hereâ€™s the base structure of a field</strong></u><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>field_type<th style=text-align:center>field<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>remaining bytes<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x00 => 0xFF<td style=text-align:center></table><br><ul><li><h4 id=character-field>Character field</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>field_type<th style=text-align:center>value<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>1 byte<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x00<td style=text-align:center>0x00 => 0xFF</table><ul><li><h4 id=integer-field-4-bytes>Integer field (4 bytes)</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>field_type<th style=text-align:center>[0]<th style=text-align:center>[1]<th style=text-align:center>[2]<th style=text-align:center>[3]<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x01<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF</table><ul><li><h4 id=unsigned-integer-field-4-bytes>Unsigned Integer field (4 bytes)</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>field_type<th style=text-align:center>[0]<th style=text-align:center>[1]<th style=text-align:center>[2]<th style=text-align:center>[3]<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x02<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF</table><ul><li><h4 id=unsigned-integer-64-field-8-bytes>Unsigned Integer 64 field (8 bytes)</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>field_type<th style=text-align:center>[0]<th style=text-align:center>[1]<th style=text-align:center>[2]<th style=text-align:center>[3]<th style=text-align:center>[4]<th style=text-align:center>[5]<th style=text-align:center>[6]<th style=text-align:center>[7]<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x03<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => OxFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF</table><ul><li><h4 id=string-field>String field</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>field_type<th style=text-align:center>size[0]<th style=text-align:center>size[1]<th style=text-align:center>size[2]<th style=text-align:center>size[3]<th style=text-align:center>[0]<th style=text-align:center><th style=text-align:center>[n]<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>n-1 bytes<td style=text-align:center>1 byte<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x04<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF<td style=text-align:center>0x00 => 0xFF</table><blockquote><h3 id=packets>Packets</h3></blockquote><p><u><strong>Hereâ€™s the base structure of a packet:</strong></u><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>magic<th style=text-align:center>packet_type<th style=text-align:center>fields[]<tbody><tr><td style=text-align:center><u><strong>size</strong></u><td style=text-align:center>1 byte<td style=text-align:center>1 byte<td style=text-align:center>remaining bytes<tr><td style=text-align:center><u><strong>value</strong></u><td style=text-align:center>0x32<td style=text-align:center>0x00 => 0xFF<td style=text-align:center></table><br><ul><li><h4 id=calluppacket>CallUpPacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>username<th style=text-align:center>hostname<th style=text-align:center>port<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>string<td style=text-align:center>string<td style=text-align:center>uint</table><ul><li><h4 id=hanguppacket>HangUpPacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>username<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>string</table><ul><li><h4 id=contactpacket>ContactPacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>username<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>string</table><ul><li><h4 id=loginerrorpacket>LoginErrorPacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>error<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>string</table><ul><li><h4 id=loginpacket>LoginPacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>username<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>string</table><ul><li><h4 id=logoutpacket>LogoutPacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>empty<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>empty</table><ul><li><h4 id=messagepacket>MessagePacket</h4></ul><table><thead><tr><th style=text-align:center><u><strong>description</strong></u><th style=text-align:center>sender<th style=text-align:center>recipient<th style=text-align:center>content<th style=text-align:center>timestamp<tbody><tr><td style=text-align:center><u><strong>field_type</strong></u><td style=text-align:center>string<td style=text-align:center>string<td style=text-align:center>string<td style=text-align:center>uint64</table><h2 id=sample-implementation>Sample implementation</h2><p>You can check out the <a href=https://github.com/paulcomte/babel/wiki rel=noopener target=_blank>GitHub wiki</a> to have more details on an example implementation.<h2 id=future>Future ?</h2><p>If I ever get the time to work on my protocol system, I would definitely write a file parser to create packets from simple json files.<p class=tagsData><a href=/tags/cpp>/cpp/</a> <a href=/tags/server>/server/</a> <a href=/tags/communication>/communication/</a></main><footer><hr><div class=footContainer><div><a href=https://512kb.club><img alt="a proud member of the green team of 512KB club" src=https://512kb.club/assets/images/green-team.svg></a></div><div><a title="250KB Club page" href=https://250kb.club/paulcomte-cafe> <img alt="badge: proud member of the 250KB Club" src=https://250kb.club/color_badge_dark.png> </a></div><div><a href=https://www.cutercounter.com/ target=_blank> <img alt="visitor counter" src="https://www.cutercounter.com/hits.php?id=hexpdofn&nd=1&style=1" border=0> </a></div></div></footer></div>